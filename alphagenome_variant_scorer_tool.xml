<tool id="alphagenome_variant_scorer" name="AlphaGenome Variant Scorer" version="0.1.0">
    <description>Predict functional effects of genetic variants using AlphaGenome</description>
    
    <requirements>
        <requirement type="package" version="3.9">python</requirement>
        <requirement type="package">alphagenome</requirement>
        <requirement type="package">pysam</requirement>
        <requirement type="package">numpy</requirement>
    </requirements>
    
    <command detect_errors="exit_code"><![CDATA[
        python '$__tool_directory__/alphagenome_score_variants.py'
            --input '$input_vcf'
            --output '$output_vcf'
            --api-key '$api_key'
            --predictions '$predictions'
            --max-variants $max_variants
            #if $reference_genome.genome_source == "history"
                --reference '$reference_genome.genome_fasta'
            #else
                --reference '$reference_genome.genome_builtin.fields.path'
            #end if
    ]]></command>
    
    <inputs>
        <param name="input_vcf" type="data" format="vcf" label="Input VCF file" 
               help="VCF file containing variants to score"/>
        
        <param name="api_key" type="text" label="AlphaGenome API Key" 
               help="Get your API key from https://deepmind.google.com/science/alphagenome">
            <sanitizer>
                <valid initial="string.ascii_letters,string.digits">
                    <add value="-"/>
                    <add value="_"/>
                </valid>
            </sanitizer>
        </param>
        
        <conditional name="reference_genome">
            <param name="genome_source" type="select" label="Reference genome source">
                <option value="builtin">Use built-in genome</option>
                <option value="history">Use genome from history</option>
            </param>
            <when value="builtin">
                <param name="genome_builtin" type="select" label="Select reference genome">
                    <options from_data_table="fasta_indexes">
                        <filter type="sort_by" column="2"/>
                        <validator type="no_options" message="No genomes available"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="genome_fasta" type="data" format="fasta" label="Reference genome"/>
            </when>
        </conditional>
        
        <param name="predictions" type="select" multiple="true" display="checkboxes" 
               label="Select predictions to include">
            <option value="expression" selected="true">Gene expression</option>
            <option value="splicing" selected="true">Splicing</option>
            <option value="chromatin" selected="true">Chromatin features</option>
            <option value="conservation">Conservation scores</option>
        </param>
        
        <param name="max_variants" type="integer" value="1000" min="1" max="10000"
               label="Maximum variants to process" 
               help="Due to API limits, processing is capped. Default: 1000"/>
    </inputs>
    
    <outputs>
        <data name="output_vcf" format="vcf" label="${tool.name} on ${on_string}"/>
    </outputs>
    
    <tests>
        <test>
            <param name="input_vcf" value="test_variants.vcf"/>
            <param name="api_key" value="test_key"/>
            <param name="genome_source" value="history"/>
            <param name="genome_fasta" value="test_reference.fa"/>
            <param name="predictions" value="expression,splicing"/>
            <output name="output_vcf" file="expected_output.vcf"/>
        </test>
    </tests>
    
    <help><![CDATA[
**AlphaGenome Variant Scorer**

This tool uses Google DeepMind's AlphaGenome model to predict the functional effects of genetic variants.

**Input:**
- VCF file containing genetic variants
- Reference genome (FASTA format)
- AlphaGenome API key (obtain from https://deepmind.google.com/science/alphagenome)

**Output:**
- Annotated VCF file with AlphaGenome predictions added as INFO fields:
  - AG_EXPR: Gene expression impact score (0-1)
  - AG_SPLICE: Splicing disruption score (0-1)
  - AG_CHROM: Chromatin impact score (0-1)
  - AG_CONS: Conservation score (0-1)

**Usage Notes:**
- This tool is for non-commercial use only
- Due to API rate limits, large VCF files will be processed in batches
- Processing time depends on the number of variants and API response time

**Citation:**
If you use this tool, please cite:
Avsec et al., 2025. "AlphaGenome: A unified model for deciphering the regulatory code of DNA sequences"
    ]]></help>
    
    <citations>
        <citation type="doi">10.1038/alphagenome2025</citation>
    </citations>
</tool>